

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ebooklib.epub &mdash; EBookLib 0.15 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.15',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="EBookLib 0.15 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">EBookLib 0.15 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ebooklib.epub</h1><div class="highlight"><pre>
<span class="c"># This file is part of EbookLib.</span>
<span class="c"># Copyright (c) 2013 Aleksandar Erkalovic &lt;aerkalov@gmail.com&gt;</span>
<span class="c">#</span>
<span class="c"># EbookLib is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># EbookLib is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU Affero General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c"># along with EbookLib.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">unquote</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">unquote</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">import</span> <span class="nn">ebooklib</span>

<span class="kn">from</span> <span class="nn">ebooklib.utils</span> <span class="kn">import</span> <span class="n">parse_string</span><span class="p">,</span> <span class="n">parse_html_string</span>


<span class="c"># This really should not be here</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>


<span class="c"># Version of EPUB library</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">NAMESPACES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;XML&#39;</span><span class="p">:</span> <span class="s">&#39;http://www.w3.org/XML/1998/namespace&#39;</span><span class="p">,</span>
              <span class="s">&#39;EPUB&#39;</span><span class="p">:</span> <span class="s">&#39;http://www.idpf.org/2007/ops&#39;</span><span class="p">,</span>
              <span class="s">&#39;DAISY&#39;</span><span class="p">:</span> <span class="s">&#39;http://www.daisy.org/z3986/2005/ncx/&#39;</span><span class="p">,</span>
              <span class="s">&#39;OPF&#39;</span><span class="p">:</span> <span class="s">&#39;http://www.idpf.org/2007/opf&#39;</span><span class="p">,</span>
              <span class="s">&#39;CONTAINERNS&#39;</span><span class="p">:</span> <span class="s">&#39;urn:oasis:names:tc:opendocument:xmlns:container&#39;</span><span class="p">,</span>
              <span class="s">&#39;DC&#39;</span><span class="p">:</span> <span class="s">&quot;http://purl.org/dc/elements/1.1/&quot;</span><span class="p">,</span>
              <span class="s">&#39;XHTML&#39;</span><span class="p">:</span> <span class="s">&#39;http://www.w3.org/1999/xhtml&#39;</span><span class="p">}</span>

<span class="c"># XML Templates</span>

<span class="n">CONTAINER_PATH</span> <span class="o">=</span> <span class="s">&#39;META-INF/container.xml&#39;</span>

<span class="n">CONTAINER_XML</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;</span>
<span class="s">&lt;container xmlns=&quot;urn:oasis:names:tc:opendocument:xmlns:container&quot; version=&quot;1.0&quot;&gt;</span>
<span class="s">  &lt;rootfiles&gt;</span>
<span class="s">    &lt;rootfile media-type=&quot;application/oebps-package+xml&quot; full-path=&quot;</span><span class="si">%(folder_name)s</span><span class="s">/content.opf&quot;/&gt;</span>
<span class="s">  &lt;/rootfiles&gt;</span>
<span class="s">&lt;/container&gt;</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="n">NCX_XML</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;!DOCTYPE ncx PUBLIC &quot;-//NISO//DTD ncx 2005-1//EN&quot; &quot;http://www.daisy.org/z3986/2005/ncx-2005-1.dtd&quot;&gt; </span>
<span class="s">&lt;ncx xmlns=&quot;http://www.daisy.org/z3986/2005/ncx/&quot; version=&quot;2005-1&quot; /&gt;&#39;&#39;&#39;</span>

<span class="n">NAV_XML</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE html&gt;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:epub=&quot;http://www.idpf.org/2007/ops&quot;/&gt;&#39;&#39;&#39;</span>

<span class="n">CHAPTER_XML</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE html&gt;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:epub=&quot;http://www.idpf.org/2007/ops&quot;  epub:prefix=&quot;z3998: http://www.daisy.org/z3998/2012/vocab/structure/#&quot;&gt;&lt;/html&gt;&#39;&#39;&#39;</span>

<span class="n">COVER_XML</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s">&lt;!DOCTYPE html&gt;</span>
<span class="s">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:epub=&quot;http://www.idpf.org/2007/ops&quot; lang=&quot;en&quot; xml:lang=&quot;en&quot;&gt;</span>
<span class="s"> &lt;head&gt;</span>
<span class="s">  &lt;style&gt;</span>
<span class="s">    body { margin: 0em; padding: 0em; }</span>
<span class="s">    img { max-width: 100%; max-height: 100%; }</span>
<span class="s">  &lt;/style&gt;</span>
<span class="s"> &lt;/head&gt;</span>
<span class="s"> &lt;body&gt;</span>
<span class="s">   &lt;img src=&quot;&quot; alt=&quot;&quot; /&gt;</span>
<span class="s"> &lt;/body&gt;</span>
<span class="s">&lt;/html&gt;&#39;&#39;&#39;</span>


<span class="n">IMAGE_MEDIA_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;image/jpeg&#39;</span><span class="p">,</span> <span class="s">&#39;image/jpg&#39;</span><span class="p">,</span> <span class="s">&#39;image/png&#39;</span><span class="p">,</span> <span class="s">&#39;image/svg+xml&#39;</span><span class="p">]</span>


<span class="c">## TOC elements</span>

<div class="viewcode-block" id="Section"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.Section">[docs]</a><span class="k">class</span> <span class="nc">Section</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
</div>
<div class="viewcode-block" id="Link"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.Link">[docs]</a><span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">href</span> <span class="o">=</span> <span class="n">href</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>

<span class="c">## Exceptions</span>
</div>
<div class="viewcode-block" id="EpubException"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubException">[docs]</a><span class="k">class</span> <span class="nc">EpubException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>

<span class="c">## Items</span>
</div>
<div class="viewcode-block" id="EpubItem"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubItem">[docs]</a><span class="k">class</span> <span class="nc">EpubItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_linear</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">book</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="EpubItem.get_id"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubItem.get_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</div>
<div class="viewcode-block" id="EpubItem.get_name"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubItem.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>
</div>
<div class="viewcode-block" id="EpubItem.get_type"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubItem.get_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guess type according to the file extension. Not the best way to do it, but works for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ext_list</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ebooklib</span><span class="o">.</span><span class="n">EXTENSIONS</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">ext_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">uid</span>

        <span class="k">return</span> <span class="n">ebooklib</span><span class="o">.</span><span class="n">ITEM_UNKNOWN</span>
        </div>
<div class="viewcode-block" id="EpubItem.get_content"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubItem.get_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="n">default</span>
</div>
<div class="viewcode-block" id="EpubItem.set_content"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubItem.set_content">[docs]</a>    <span class="k">def</span> <span class="nf">set_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubItem:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</div>
<div class="viewcode-block" id="EpubNcx"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubNcx">[docs]</a><span class="k">class</span> <span class="nc">EpubNcx</span><span class="p">(</span><span class="n">EpubItem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="s">&#39;ncx&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;toc.ncx&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpubNcx</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s">&quot;application/x-dtbncx+xml&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubNcx:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

</div>
<div class="viewcode-block" id="EpubCover"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubCover">[docs]</a><span class="k">class</span> <span class="nc">EpubCover</span><span class="p">(</span><span class="n">EpubItem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="s">&#39;cover-img&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpubCover</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubCover:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

        </div>
<div class="viewcode-block" id="EpubHtml"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml">[docs]</a><span class="k">class</span> <span class="nc">EpubHtml</span><span class="p">(</span><span class="n">EpubItem</span><span class="p">):</span>
    <span class="n">_template_name</span> <span class="o">=</span> <span class="s">&#39;chapter&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpubHtml</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="EpubHtml.is_chapter"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.is_chapter">[docs]</a>    <span class="k">def</span> <span class="nf">is_chapter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="EpubHtml.get_type"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.get_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ebooklib</span><span class="o">.</span><span class="n">ITEM_DOCUMENT</span>
</div>
<div class="viewcode-block" id="EpubHtml.set_language"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.set_language">[docs]</a>    <span class="k">def</span> <span class="nf">set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>
</div>
<div class="viewcode-block" id="EpubHtml.get_language"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.get_language">[docs]</a>    <span class="k">def</span> <span class="nf">get_language</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span>
</div>
<div class="viewcode-block" id="EpubHtml.add_link"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.add_link">[docs]</a>    <span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwgs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwgs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubHtml.get_links"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.get_links">[docs]</a>    <span class="k">def</span> <span class="nf">get_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubHtml.get_links_of_type"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.get_links_of_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_links_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">link_type</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubHtml.add_item"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.add_item">[docs]</a>    <span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ebooklib</span><span class="o">.</span><span class="n">ITEM_STYLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ebooklib</span><span class="o">.</span><span class="n">ITEM_SCRIPT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubHtml.get_body_content"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.get_body_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_body_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">html_tree</span> <span class="o">=</span> <span class="n">parse_html_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="n">html_root</span> <span class="o">=</span> <span class="n">html_tree</span><span class="o">.</span><span class="n">getroottree</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">html_root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">html_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>

            <span class="n">tree_str</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        
            <span class="c"># this is so stupid</span>
            <span class="k">if</span> <span class="n">tree_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;body&gt;&#39;</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">tree_str</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;&lt;/body&gt;&#39;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">tree_str</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">tree_str</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span>

</div>
<div class="viewcode-block" id="EpubHtml.get_content"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubHtml.get_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_template_name</span><span class="p">))</span>
        <span class="n">tree_root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">tree_root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">tree_root</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}lang&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;XML&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">language</span>

        <span class="c"># add to the head also</span>
        <span class="c">#  &lt;meta charset=&quot;utf-8&quot; /&gt;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">html_tree</span> <span class="o">=</span> <span class="n">parse_html_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="n">html_root</span> <span class="o">=</span> <span class="n">html_tree</span><span class="o">.</span><span class="n">getroottree</span><span class="p">()</span>

        <span class="c"># create and populate head</span>

        <span class="n">_head</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">tree_root</span><span class="p">,</span> <span class="s">&#39;head&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">_title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">_head</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">)</span>
            <span class="n">_title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>

        <span class="k">for</span> <span class="n">lnk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">_lnk</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">_head</span><span class="p">,</span> <span class="s">&#39;link&#39;</span><span class="p">,</span> <span class="n">lnk</span><span class="p">)</span>

        <span class="c"># this should not be like this</span>
        <span class="c"># head = html_root.find(&#39;head&#39;)</span>
        <span class="c"># if head is not None:</span>
        <span class="c">#     for i in head.getchildren():</span>
        <span class="c">#         if i.tag == &#39;title&#39; and self.title != &#39;&#39;:</span>
        <span class="c">#             continue</span>
        <span class="c">#         _head.append(i)</span>

        <span class="c"># create and populate body</span>

        <span class="n">_body</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">tree_root</span><span class="p">,</span> <span class="s">&#39;body&#39;</span><span class="p">)</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">html_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">body</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="n">_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">tree_str</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        

        <span class="k">return</span> <span class="n">tree_str</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubHtml:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="EpubCoverHtml"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubCoverHtml">[docs]</a><span class="k">class</span> <span class="nc">EpubCoverHtml</span><span class="p">(</span><span class="n">EpubHtml</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="s">&#39;cover&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;cover.xhtml&#39;</span><span class="p">,</span> <span class="n">image_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Cover&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpubCoverHtml</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_name</span> <span class="o">=</span> <span class="n">image_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_linear</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="EpubCoverHtml.is_chapter"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubCoverHtml.is_chapter">[docs]</a>    <span class="k">def</span> <span class="nf">is_chapter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="EpubCoverHtml.get_content"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubCoverHtml.get_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;cover&#39;</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">EpubCoverHtml</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_content</span><span class="p">())</span>
        <span class="n">tree_root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">tree_root</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&#39;//xhtml:img&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;xhtml&#39;</span><span class="p">:</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;XHTML&#39;</span><span class="p">]})</span>

        <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;alt&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="n">tree_str</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        

        <span class="k">return</span> <span class="n">tree_str</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubCoverHtml:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubNav"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubNav">[docs]</a><span class="k">class</span> <span class="nc">EpubNav</span><span class="p">(</span><span class="n">EpubHtml</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="s">&#39;nav&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;nav.xhtml&#39;</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s">&quot;application/xhtml+xml&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpubNav</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">media_type</span><span class="p">)</span>

<div class="viewcode-block" id="EpubNav.is_chapter"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubNav.is_chapter">[docs]</a>    <span class="k">def</span> <span class="nf">is_chapter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>        
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubNav:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="EpubImage"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubImage">[docs]</a><span class="k">class</span> <span class="nc">EpubImage</span><span class="p">(</span><span class="n">EpubItem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EpubImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="EpubImage.get_type"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubImage.get_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ebooklib</span><span class="o">.</span><span class="n">ITEM_IMAGE</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;EpubImage:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>


<span class="c">## EpubBook</span>
</div>
<div class="viewcode-block" id="EpubBook"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook">[docs]</a><span class="k">class</span> <span class="nc">EpubBook</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EPUB_VERSION</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c"># we should have options here</span>
        
<div class="viewcode-block" id="EpubBook.reset"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Initialises all needed variables to default values&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spine</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guide</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_ID</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FOLDER_NAME</span> <span class="o">=</span> <span class="s">&#39;EPUB&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id_html</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_image</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_static</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="s">&#39;en&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;ncx&#39;</span><span class="p">:</span> <span class="n">NCX_XML</span><span class="p">,</span>
                          <span class="s">&#39;nav&#39;</span><span class="p">:</span> <span class="n">NAV_XML</span><span class="p">,</span>
                          <span class="s">&#39;chapter&#39;</span><span class="p">:</span> <span class="n">CHAPTER_XML</span><span class="p">,</span>
                          <span class="s">&#39;cover&#39;</span><span class="p">:</span> <span class="n">COVER_XML</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s">&#39;OPF&#39;</span><span class="p">,</span> <span class="s">&#39;generator&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;generator&#39;</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="s">&#39;Ebook-lib </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">VERSION</span><span class="p">])})</span>

</div>
<div class="viewcode-block" id="EpubBook.set_identifier"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.set_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">set_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="s">&quot;Sets unique id for this epub&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s">&#39;DC&#39;</span><span class="p">,</span> <span class="s">&#39;identifier&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">IDENTIFIER_ID</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="EpubBook.set_title"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.set_title">[docs]</a>    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="s">&quot;Set title. You can set multiple titles.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s">&#39;DC&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubBook.set_language"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.set_language">[docs]</a>    <span class="k">def</span> <span class="nf">set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="s">&quot;Set language for this epub. You can set multiple languages.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">lang</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s">&#39;DC&#39;</span><span class="p">,</span> <span class="s">&#39;language&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubBook.set_cover"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.set_cover">[docs]</a>    <span class="k">def</span> <span class="nf">set_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">create_page</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Set cover and create cover document if needed.&quot;</span>

        <span class="c"># as it is now, it can only be called once</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">EpubCover</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">c0</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">c0</span><span class="p">)</span>        

        <span class="k">if</span> <span class="n">create_page</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">EpubCoverHtml</span><span class="p">(</span><span class="n">image_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;cover&#39;</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="s">&#39;cover-img&#39;</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="EpubBook.add_author"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.add_author">[docs]</a>    <span class="k">def</span> <span class="nf">add_author</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">file_as</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="s">&#39;creator&#39;</span><span class="p">):</span>
        <span class="s">&quot;Add author for this document&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s">&#39;DC&#39;</span><span class="p">,</span> <span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">uid</span><span class="p">})</span>
 
        <span class="k">if</span> <span class="n">file_as</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="n">file_as</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;refines&#39;</span><span class="p">:</span> <span class="s">&#39;#&#39;</span><span class="o">+</span><span class="n">uid</span><span class="p">,</span>
                                                    <span class="s">&#39;property&#39;</span><span class="p">:</span> <span class="s">&#39;file-as&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;scheme&#39;</span><span class="p">:</span> <span class="s">&#39;marc:relators&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;refines&#39;</span><span class="p">:</span> <span class="s">&#39;#&#39;</span><span class="o">+</span><span class="n">uid</span><span class="p">,</span>
                                                 <span class="s">&#39;property&#39;</span><span class="p">:</span> <span class="s">&#39;role&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;scheme&#39;</span><span class="p">:</span> <span class="s">&#39;marc:relators&#39;</span><span class="p">})</span>
                                </div>
<div class="viewcode-block" id="EpubBook.add_metadata"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Add metadata&quot;</span>

        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">NAMESPACES</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">namespace</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="n">value</span><span class="p">,</span> <span class="n">others</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="EpubBook.get_metadata"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="s">&quot;Retrieve metadata&quot;</span>

        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">NAMESPACES</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="n">namespace</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="EpubBook.add_item"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.add_item">[docs]</a>    <span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">media_type</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">has_guessed</span><span class="p">,</span> <span class="n">media_type</span><span class="p">)</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">has_guessed</span><span class="p">:</span>
                <span class="k">if</span>  <span class="n">media_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">has_guessed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="s">&#39;application/octet-stream&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">get_id</span><span class="p">():</span>
            <span class="c"># make chapter_, image_ and static_ configurable</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubHtml</span><span class="p">):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&#39;chapter_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_html</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id_html</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubImage</span><span class="p">):</span>
                <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&#39;image_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id_image</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&#39;static_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id_image</span> <span class="o">+=</span> <span class="mi">1</span>                

        <span class="n">item</span><span class="o">.</span><span class="n">book</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">item</span>
</div>
<div class="viewcode-block" id="EpubBook.get_item_with_id"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_item_with_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_item_with_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span>

        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="EpubBook.get_item_with_href"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_item_with_href">[docs]</a>    <span class="k">def</span> <span class="nf">get_item_with_href</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">href</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span>

        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="EpubBook.get_items"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubBook.get_items_of_type"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_items_of_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_items_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">item_type</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubBook.get_items_of_media_type"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_items_of_media_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_items_of_media_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">media_type</span> <span class="o">==</span> <span class="n">media_type</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubBook.set_template"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.set_template">[docs]</a>    <span class="k">def</span> <span class="nf">set_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    </div>
<div class="viewcode-block" id="EpubBook.get_template"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubBook.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="c">###########################################################################################################</span>
</div></div>
<div class="viewcode-block" id="EpubWriter"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubWriter">[docs]</a><span class="k">class</span> <span class="nc">EpubWriter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>    
    <span class="n">DEFAULT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;epub2_guide&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                       <span class="s">&#39;epub3_landmark&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                       <span class="s">&#39;landmark_title&#39;</span><span class="p">:</span> <span class="s">&#39;Guide&#39;</span>
                      <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book</span> <span class="o">=</span> <span class="n">book</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="EpubWriter.process"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubWriter.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># should cache this html parsing so we don&#39;t do it for every plugin</span>
        <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plugins&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plg</span><span class="p">,</span> <span class="s">&#39;before_write&#39;</span><span class="p">):</span>
                <span class="n">plg</span><span class="o">.</span><span class="n">before_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubHtml</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plugins&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plg</span><span class="p">,</span> <span class="s">&#39;html_before_write&#39;</span><span class="p">):</span>
                        <span class="n">plg</span><span class="o">.</span><span class="n">html_before_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_write_container</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">container_xml</span> <span class="o">=</span> <span class="n">CONTAINER_XML</span> <span class="o">%</span> <span class="p">{</span> <span class="s">&#39;folder_name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">FOLDER_NAME</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">CONTAINER_PATH</span><span class="p">,</span> <span class="n">container_xml</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_opf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;package&#39;</span><span class="p">,</span>
                             <span class="p">{</span><span class="s">&#39;xmlns&#39;</span> <span class="p">:</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">],</span>
                              <span class="s">&#39;unique-identifier&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">IDENTIFIER_ID</span><span class="p">,</span>
                              <span class="s">&#39;version&#39;</span> <span class="p">:</span> <span class="s">&#39;3.0&#39;</span><span class="p">})</span>

        <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;rendition: http://www.ipdf.org/vocab/rendition/#&#39;</span>
         
        <span class="c">## METADATA</span>


        <span class="n">nsmap</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;dc&#39;</span><span class="p">:</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;DC&#39;</span><span class="p">],</span> <span class="s">&#39;opf&#39;</span><span class="p">:</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">]}</span>

        <span class="c"># This is really not needed </span>
        <span class="c"># problem is uppercase/lowercase</span>

        <span class="c"># for ns_name, values in six.iteritems(self.book.metadata):</span>
        <span class="c">#     if ns_name:</span>
        <span class="c">#         for n_id, ns_url in six.iteritems(NAMESPACES):</span>
        <span class="c">#             if ns_name == ns_url:</span>
        <span class="c">#                 nsmap[n_id.lower()] = NAMESPACES[n_id]        </span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">nsmap</span> <span class="o">=</span> <span class="n">nsmap</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">datetime</span>

        <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;property&#39;</span><span class="p">:</span><span class="s">&#39;dcterms:modified&#39;</span><span class="p">})</span>
        <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%SZ&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ns_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">metadata</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ns_name</span> <span class="o">==</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not create metadata.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ns_name</span><span class="p">:</span>
                                <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&#39;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ns_name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                            <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not create metadata &quot;{}&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


        <span class="c"># MANIFEST</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;manifest&#39;</span><span class="p">)</span>
        <span class="n">_ncx_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># mathml, scripted, svg, remote-resources, and switch</span>
        <span class="c"># nav</span>
        <span class="c"># cover-image</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubNav</span><span class="p">):</span>
                <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                                                    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="s">&#39;media-type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
                                                    <span class="s">&#39;properties&#39;</span><span class="p">:</span> <span class="s">&#39;nav&#39;</span><span class="p">})</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubNcx</span><span class="p">):</span>
                <span class="n">_ncx_id</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span>
                <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span>
                                                    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="s">&#39;media-type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">media_type</span><span class="p">})</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubCover</span><span class="p">):</span>
                <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span>
                                                    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="s">&#39;media-type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">media_type</span><span class="p">,</span>
                                                    <span class="s">&#39;properties&#39;</span><span class="p">:</span> <span class="s">&#39;cover-image&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span>
                        <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s">&#39;media-type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">media_type</span><span class="p">}</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;properties&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">opts</span><span class="p">[</span><span class="s">&#39;properties&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>

                <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
            
        <span class="c"># SPINE</span>
        <span class="n">spine</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;spine&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;toc&#39;</span><span class="p">:</span> <span class="n">_ncx_id</span> <span class="ow">or</span> <span class="s">&#39;ncx&#39;</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">spine</span><span class="p">:</span>
            <span class="c"># this is for now</span>
            <span class="c"># later we should be able to fetch things from tuple</span>

            <span class="n">is_linear</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;no&#39;</span><span class="p">:</span>
                        <span class="n">is_linear</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">_item</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubHtml</span><span class="p">):</span>
                <span class="n">opts</span> <span class="o">=</span>  <span class="p">{</span><span class="s">&#39;idref&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get_id</span><span class="p">()}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">is_linear</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_linear</span><span class="p">:</span>
                    <span class="n">opts</span><span class="p">[</span><span class="s">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubItem</span><span class="p">):</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;idref&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get_id</span><span class="p">()}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">is_linear</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_linear</span><span class="p">:</span>
                    <span class="n">opts</span><span class="p">[</span><span class="s">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;idref&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_item_with_id</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">itm</span><span class="o">.</span><span class="n">is_linear</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_linear</span><span class="p">:</span>
                        <span class="n">opts</span><span class="p">[</span><span class="s">&#39;linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no&#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">spine</span><span class="p">,</span> <span class="s">&#39;itemref&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>

        <span class="c"># GUIDE</span>
        <span class="c"># - http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.6</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">guide</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;epub2_guide&#39;</span><span class="p">):</span>
            <span class="n">guide</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;guide&#39;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">guide</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;item&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">chap</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;item&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">chap</span><span class="p">:</span>
                        <span class="n">_href</span> <span class="o">=</span> <span class="n">chap</span><span class="o">.</span><span class="n">file_name</span>
                        <span class="n">_title</span> <span class="o">=</span> <span class="n">chap</span><span class="o">.</span><span class="n">title</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_href</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">_title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

                <span class="n">ref</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">guide</span><span class="p">,</span> <span class="s">&#39;reference&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> 
                                                            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">_title</span><span class="p">,</span>
                                                            <span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">_href</span><span class="p">})</span>

        <span class="n">tree_str</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/content.opf&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">FOLDER_NAME</span><span class="p">,</span> <span class="n">tree_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_nav</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c"># just a basic navigation for now</span>
        <span class="n">ncx</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;nav&#39;</span><span class="p">))</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ncx</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}lang&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;XML&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">language</span>


        <span class="n">head</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;head&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">)</span>
        <span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">title</span>

        <span class="c"># for now this just handles css files and ignores others</span>
        <span class="k">for</span> <span class="n">_link</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">_lnk</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;link&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;href&quot;</span><span class="p">:</span><span class="n">_link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&quot;rel&quot;</span><span class="p">:</span><span class="s">&quot;stylesheet&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">:</span><span class="s">&quot;text/css&quot;</span><span class="p">})</span>        

        <span class="n">body</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;body&#39;</span><span class="p">)</span>
        <span class="n">nav</span>  <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s">&#39;nav&#39;</span><span class="p">,</span>  <span class="p">{</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}type&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;EPUB&#39;</span><span class="p">]:</span> <span class="s">&#39;toc&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;id&#39;</span><span class="p">})</span>

        <span class="n">content_title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">nav</span><span class="p">,</span> <span class="s">&#39;h2&#39;</span><span class="p">)</span>
        <span class="n">content_title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">title</span>

        <span class="k">def</span> <span class="nf">_create_section</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
            <span class="n">ol</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="s">&#39;ol&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">ol</span><span class="p">,</span> <span class="s">&#39;li&#39;</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="s">&#39;span&#39;</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span>

                    <span class="n">_create_section</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Link</span><span class="p">):</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">ol</span><span class="p">,</span> <span class="s">&#39;li&#39;</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">href</span><span class="p">})</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">title</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubHtml</span><span class="p">):</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">ol</span><span class="p">,</span> <span class="s">&#39;li&#39;</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">})</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">title</span>

        <span class="n">_create_section</span><span class="p">(</span><span class="n">nav</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">toc</span><span class="p">)</span>

        <span class="c"># LANDMARKS / GUIDE</span>
        <span class="c"># - http://www.idpf.org/epub/30/spec/epub30-contentdocs.html#sec-xhtml-nav-def-types-landmarks</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">guide</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;epub3_landmark&#39;</span><span class="p">):</span> 
            <span class="n">guide_nav</span>  <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s">&#39;nav&#39;</span><span class="p">,</span>  <span class="p">{</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}type&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;EPUB&#39;</span><span class="p">]:</span> <span class="s">&#39;landmarks&#39;</span><span class="p">})</span>

            <span class="n">guide_content_title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">guide_nav</span><span class="p">,</span> <span class="s">&#39;h2&#39;</span><span class="p">)</span>
            <span class="n">guide_content_title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;landmark_title&#39;</span><span class="p">,</span> <span class="s">&#39;Guide&#39;</span><span class="p">)</span>

            <span class="n">guild_ol</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">guide_nav</span><span class="p">,</span> <span class="s">&#39;ol&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">guide</span><span class="p">:</span>
                <span class="n">li_item</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">guild_ol</span><span class="p">,</span> <span class="s">&#39;li&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s">&#39;item&#39;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="n">chap</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;item&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">chap</span><span class="p">:</span>
                        <span class="n">_href</span> <span class="o">=</span> <span class="n">chap</span><span class="o">.</span><span class="n">file_name</span>
                        <span class="n">_title</span> <span class="o">=</span> <span class="n">chap</span><span class="o">.</span><span class="n">title</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_href</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">_title</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

                <span class="n">a_item</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">li_item</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}type&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;EPUB&#39;</span><span class="p">]:</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">_href</span><span class="p">})</span>
                <span class="n">a_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">_title</span>

        <span class="n">tree_str</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        

        <span class="k">return</span> <span class="n">tree_str</span>

    <span class="k">def</span> <span class="nf">_get_ncx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># we should be able to setup language for NCX as also</span>
        <span class="n">ncx</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;ncx&#39;</span><span class="p">))</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ncx</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">head</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;head&#39;</span><span class="p">)</span>

        <span class="c"># get this id</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;dtb:uid&#39;</span><span class="p">})</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;dtb:depth&#39;</span><span class="p">})</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;dtb:totalPageCount&#39;</span><span class="p">})</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="s">&#39;meta&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;dtb:maxPageNumber&#39;</span><span class="p">})</span>

        <span class="n">doc_title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;docTitle&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">doc_title</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">)</span>
        <span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">title</span>

<span class="c">#        doc_author = etree.SubElement(root, &#39;docAuthor&#39;)</span>
<span class="c">#        author = etree.SubElement(doc_author, &#39;text&#39;)</span>
<span class="c">#        author.text = &#39;Name of the person&#39;</span>

        <span class="c"># For now just make a very simple navMap</span>
        <span class="n">nav_map</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;navMap&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_create_section</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">section</span><span class="p">,</span> <span class="n">subsection</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">np</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="s">&#39;navPoint&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;sep_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">uid</span><span class="p">})</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&#39;navLabel&#39;</span><span class="p">)</span>
                    <span class="n">nt</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">nl</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">)</span>
                    <span class="n">nt</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">title</span>

                    <span class="c"># CAN NOT HAVE EMPTY SRC HERE</span>
                    <span class="n">nc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;src&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">})</span>

                    <span class="c">#uid += 1</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="n">_create_section</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">subsection</span><span class="p">,</span> <span class="n">uid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Link</span><span class="p">):</span>
                    <span class="n">_parent</span> <span class="o">=</span> <span class="n">itm</span>
                    <span class="n">_content</span> <span class="o">=</span> <span class="n">_parent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_content</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">_content</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">href</span><span class="p">)</span>

                    <span class="n">np</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="s">&#39;navPoint&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">uid</span><span class="p">})</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&#39;navLabel&#39;</span><span class="p">)</span>
                    <span class="n">nt</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">nl</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">)</span>
                    <span class="n">nt</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">title</span>

                    <span class="n">nc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;src&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">href</span><span class="p">})</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubHtml</span><span class="p">):</span>
                    <span class="n">_parent</span> <span class="o">=</span> <span class="n">itm</span>
                    <span class="n">_content</span> <span class="o">=</span> <span class="n">_parent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_content</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">_content</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>

                    <span class="n">np</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="s">&#39;navPoint&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">get_id</span><span class="p">()})</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&#39;navLabel&#39;</span><span class="p">)</span>
                    <span class="n">nt</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">nl</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">)</span>
                    <span class="n">nt</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">title</span>

                    <span class="n">nc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;src&#39;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">uid</span>

        <span class="n">_create_section</span><span class="p">(</span><span class="n">nav_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">toc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">tree_str</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        

        <span class="k">return</span> <span class="n">tree_str</span>
        
    <span class="k">def</span> <span class="nf">_write_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubNcx</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">FOLDER_NAME</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ncx</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubNav</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">FOLDER_NAME</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nav</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">FOLDER_NAME</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">file_name</span><span class="p">),</span> <span class="n">item</span><span class="o">.</span><span class="n">get_content</span><span class="p">())</span>

<div class="viewcode-block" id="EpubWriter.write"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubWriter.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check for the option allowZip64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s">&#39;mimetype&#39;</span><span class="p">,</span> <span class="s">&#39;application/epub+zip&#39;</span><span class="p">,</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_STORED</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_container</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_opf_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_items</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c">###########################################################################################################</span>
</div></div>
<div class="viewcode-block" id="EpubReader"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubReader">[docs]</a><span class="k">class</span> <span class="nc">EpubReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">DEFAULT_OPTIONS</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epub_file_name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">epub_file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book</span> <span class="o">=</span> <span class="n">EpubBook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zf</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opf_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="EpubReader.process"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubReader.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># should cache this html parsing so we don&#39;t do it for every plugin</span>
        <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plugins&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plg</span><span class="p">,</span> <span class="s">&#39;after_read&#39;</span><span class="p">):</span>
                <span class="n">plg</span><span class="o">.</span><span class="n">after_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubHtml</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plugins&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plg</span><span class="p">,</span> <span class="s">&#39;html_after_read&#39;</span><span class="p">):</span>
                        <span class="n">plg</span><span class="o">.</span><span class="n">html_after_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EpubReader.load"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubReader.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span>
        </div>
<div class="viewcode-block" id="EpubReader.read_file"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.EpubReader.read_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c"># Raises KeyError</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_load_container</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">meta_inf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s">&#39;META-INF/container.xml&#39;</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="n">meta_inf</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">root_file</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;//xmlns:rootfile[@media-type]&#39;</span><span class="p">,</span> <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xmlns&#39;</span><span class="p">:</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;CONTAINERNS&#39;</span><span class="p">]}):</span>
            <span class="k">if</span> <span class="n">root_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;media-type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;application/oebps-package+xml&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opf_file</span> <span class="o">=</span>  <span class="n">root_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;full-path&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">container_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="c"># get epub version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">container_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># get unique-identifier</span>
        <span class="k">if</span> <span class="n">container_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;unique-identifier&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">IDENTIFIER_ID</span> <span class="o">=</span> <span class="n">container_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;unique-identifier&#39;</span><span class="p">)</span>

        <span class="c"># get xml:lang</span>
        <span class="c"># get metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">],</span> <span class="s">&#39;metadata&#39;</span><span class="p">))</span>

        <span class="n">nsmap</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">nsmap</span>
        <span class="n">nstags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="s">&#39;{</span><span class="si">%s</span><span class="s">}&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">nsmap</span><span class="p">))</span>
        <span class="n">default_ns</span> <span class="o">=</span> <span class="n">nstags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="n">nsdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nsmap</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ns</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nsdict</span><span class="p">:</span>
                <span class="n">nsdict</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">nsdict</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">extra</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">etree</span><span class="o">.</span><span class="n">iselement</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">default_ns</span> <span class="o">+</span> <span class="s">&#39;meta&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
                <span class="n">others</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="bp">None</span>
                
                <span class="n">add_item</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">nsmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">others</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;dc&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;identifier&#39;</span><span class="p">:</span>
                    <span class="n">_id</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_id</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">IDENTIFIER_ID</span> <span class="o">=</span> <span class="n">_id</span>

                <span class="n">others</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">nsmap</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">prefix</span><span class="p">],</span> <span class="n">tag</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">others</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">nsdict</span>

        <span class="n">titles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s">&#39;DC&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">others</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s">&quot;DC&quot;</span><span class="p">,</span> <span class="s">&quot;identifier&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">others</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">IDENTIFIER_ID</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_load_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">],</span> <span class="s">&#39;manifest&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s">&#39;{</span><span class="si">%s</span><span class="s">}item&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">media_type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;media-type&#39;</span><span class="p">)</span>
            <span class="n">_properties</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;properties&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> 

            <span class="k">if</span> <span class="n">_properties</span><span class="p">:</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="n">_properties</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># people use wrong content types</span>
            <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s">&#39;image/jpg&#39;</span><span class="p">:</span>
                <span class="n">media_type</span> <span class="o">=</span> <span class="s">&#39;image/jpeg&#39;</span>

            <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s">&#39;application/x-dtbncx+xml&#39;</span><span class="p">:</span>
                <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubNcx</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)))</span>

                <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="n">ei</span><span class="o">.</span><span class="n">file_name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s">&#39;application/xhtml+xml&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;nav&#39;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubNav</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)))</span>

                    <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="s">&#39;cover&#39;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubCoverHtml</span><span class="p">()</span>

                    <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span>  <span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubHtml</span><span class="p">()</span>

                    <span class="n">ei</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">))</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="n">ei</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
            <span class="k">elif</span> <span class="n">media_type</span> <span class="ow">in</span> <span class="n">IMAGE_MEDIA_TYPES</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;cover-image&#39;</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubCover</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span> <span class="n">file_name</span><span class="o">=</span><span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)))</span>

                    <span class="n">ei</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="n">ei</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubImage</span><span class="p">()</span>

                    <span class="n">ei</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">))</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>
                    <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="n">ei</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># different types</span>
                <span class="n">ei</span> <span class="o">=</span> <span class="n">EpubItem</span><span class="p">()</span>
                
                <span class="n">ei</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
                <span class="n">ei</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">))</span>
                <span class="n">ei</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">media_type</span>

                <span class="n">ei</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="n">ei</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
              <span class="c"># r.get(&#39;properties&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_parse_ncx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="n">tree_root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">nav_map</span> <span class="o">=</span> <span class="n">tree_root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}navMap&#39;</span> <span class="o">%</span> <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;DAISY&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nid</span><span class="p">):</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">elems</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;{</span><span class="si">%s</span><span class="s">}navLabel&#39;</span> <span class="o">%</span>  <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;DAISY&#39;</span><span class="p">]:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;{</span><span class="si">%s</span><span class="s">}content&#39;</span> <span class="o">%</span>  <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;DAISY&#39;</span><span class="p">]:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;{</span><span class="si">%s</span><span class="s">}navPoint&#39;</span> <span class="o">%</span>  <span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;DAISY&#39;</span><span class="p">]:</span>
                    <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_get_children</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">children</span>

                <span class="k">return</span> <span class="p">(</span><span class="n">Section</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                        <span class="n">children</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">Link</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nid</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="n">_get_children</span><span class="p">(</span><span class="n">nav_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_parse_nav</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
        <span class="n">html_node</span> <span class="o">=</span> <span class="n">parse_html_string</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">nav_node</span> <span class="o">=</span> <span class="n">html_node</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//nav[@*=&#39;toc&#39;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">parse_list</span><span class="p">(</span><span class="n">list_node</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">item_node</span> <span class="ow">in</span> <span class="n">list_node</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;li&quot;</span><span class="p">):</span>

                <span class="n">sublist_node</span> <span class="o">=</span> <span class="n">item_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;ol&quot;</span><span class="p">)</span>
                <span class="n">link_node</span>    <span class="o">=</span> <span class="n">item_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sublist_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">title</span>    <span class="o">=</span> <span class="n">item_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">children</span> <span class="o">=</span> <span class="n">parse_list</span><span class="p">(</span><span class="n">sublist_node</span><span class="p">)</span>

                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Section</span><span class="p">(</span><span class="n">title</span><span class="p">),</span> <span class="n">children</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">link_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">link_node</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">href</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">link_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">)))</span>

                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Link</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">title</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">items</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="n">parse_list</span><span class="p">(</span><span class="n">nav_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;ol&quot;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_load_spine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">spine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">],</span> <span class="s">&#39;spine&#39;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">spine</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;idref&#39;</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;linear&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spine</span><span class="p">]</span>

        <span class="n">toc</span> <span class="o">=</span> <span class="n">spine</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;toc&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># should read ncx or nav file</span>
        <span class="k">if</span> <span class="n">toc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ncxFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">get_item_with_id</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EpubError</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;Can not find ncx file.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ncx</span><span class="p">(</span><span class="n">ncxFile</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_load_guide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NAMESPACES</span><span class="p">[</span><span class="s">&#39;OPF&#39;</span><span class="p">],</span> <span class="s">&#39;guide&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">guide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">guide</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;href&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">),</span> <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">),</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">guide</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_load_opf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opf_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EpubError</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;Can not find container file&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">parse_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_manifest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_spine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_guide</span><span class="p">()</span>

        <span class="c"># read nav file if found</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">toc</span><span class="p">:</span>
            <span class="n">nav_item</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">items</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">EpubNav</span><span class="p">)),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nav_item</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_nav</span><span class="p">(</span><span class="n">nav_item</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">nav_item</span><span class="o">.</span><span class="n">file_name</span><span class="p">))</span>

    
    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">allowZip64</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipfile</span> <span class="k">as</span> <span class="n">bz</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EpubException</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;Bad Zip file&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">LargeZipFile</span> <span class="k">as</span> <span class="n">bz</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EpubException</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;Large Zip file&#39;</span><span class="p">)</span>

        <span class="c"># 1st check metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_container</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_opf_file</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">zf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c">## WRITE</span>
</div>
<div class="viewcode-block" id="write_epub"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.write_epub">[docs]</a><span class="k">def</span> <span class="nf">write_epub</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">epub</span> <span class="o">=</span> <span class="n">EpubWriter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="n">epub</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">epub</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c">## READ</span>
</div>
<div class="viewcode-block" id="read_epub"><a class="viewcode-back" href="../../ebooklib.html#ebooklib.epub.read_epub">[docs]</a><span class="k">def</span> <span class="nf">read_epub</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">EpubReader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="n">book</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">book</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">EBookLib 0.15 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Aleksandar Erkalovic.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>